<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/png" href="img/favicon-256.png" />
		<title>Генератор цінників</title>
		<style>
			#loading.spinner {
				left: 50%;
				margin-left: -20px;
				top: 50%;
				margin-top: -20px;
				position: absolute;
				z-index: 19 !important;
				animation: loading-bar-spinner 400ms linear infinite;
			}

			#loading.spinner .spinner-icon {
				width: 40px;
				height: 40px;
				border: solid 4px transparent;
				border-top-color: #0d6efd !important;
				border-left-color: #0d6efd !important;
				border-radius: 50%;
			}

			@keyframes loading-bar-spinner {
				0% {
					transform: rotate(0deg);
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
					transform: rotate(360deg);
				}
			}
		</style>
		<!-- Підключення скрипта Telegram -->
		<script src="https://telegram.org/js/telegram-web-app.js"></script>

		<script>
			// Функція для ініціалізації Telegram SDK та отримання користувача
			function initTelegramApp() {
				return new Promise((resolve) => {
					// Перевіряємо чи завантажився Telegram SDK
					if (window.Telegram && window.Telegram.WebApp) {
						const tg = window.Telegram.WebApp;
						tg.ready();
						
						// Отримуємо дані користувача
						let userData = null;
						if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
							userData = tg.initDataUnsafe.user;
							console.log("Telegram user data received:", userData);
							// Зберігаємо дані глобально
							window.tgCoachedUser = userData;
						} else {
							console.warn("Telegram user data not available");
						}
						
						resolve(userData);
					} else {
						console.error("Telegram Web App SDK not loaded");
						resolve(null);
					}
				});
			}

			// Чекаємо повного завантаження сторінки
			window.addEventListener('load', async (event) => {
				const strApplicationURL = "https://script.google.com/macros/s/AKfycbziQ8yhxcFE1H_tVakl5Q4saQjFx0M7PBFey4fIZqIr1lyla7wR_P-We7pvjfBsVaY3NQ/exec";
				const strCurUrl = new URL(window.location.href);

				// Ініціалізуємо Telegram SDK та отримуємо користувача
				const userData = await initTelegramApp();

				// Формуємо параметри URL
				let strCode = (strCurUrl.searchParams.get("code") || '');
				if (strCode !== '') {
					strCode = '&code=' + strCode;
				}

				// Додаємо дані користувача до URL якщо вони є
				let userParams = '';
				if (userData) {
					userParams = '&tgUserId=' + encodeURIComponent(userData.id || '');
					if (userData.first_name) {
						userParams += '&tgFirstName=' + encodeURIComponent(userData.first_name);
					}
					if (userData.last_name) {
						userParams += '&tgLastName=' + encodeURIComponent(userData.last_name);
					}
					if (userData.username) {
						userParams += '&tgUsername=' + encodeURIComponent(userData.username);
					}
					if (userData.language_code) {
						userParams += '&tgLang=' + encodeURIComponent(userData.language_code);
					}
				}

				// Створюємо iframe з даними користувача
				let objIframe = document.createElement("iframe");
				objIframe.id = "iframeWindow";
				objIframe.setAttribute("style", "display: none; position: fixed; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; border: none; margin: 0; padding: 0; overflow: hidden; z-index: 99999");
				objIframe.src = strApplicationURL + "?strParent=" + location.protocol + '//' + location.host + location.pathname + strCode + userParams;
				
				objIframe.onload = () => {
					document.getElementById('loading').remove();
					document.getElementById('iframeWindow').style.display = 'block';
					if (strCode !== '') {
						setTimeout(() => { window.close(); }, 5000);
					}
				};
				
				document.body.appendChild(objIframe);
				console.log("Iframe created with URL:", objIframe.src);
			});
		</script>
	</head>
	<body>
		<div id="loading" class="spinner"><div class="spinner-icon"></div></div>
	</body>
</html>
